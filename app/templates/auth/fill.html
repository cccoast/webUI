{% extends "base.html" %}
{% import "bootstrap/wtf.html" as wtf %}

{% block title %}Platform{% endblock %}

{% block page_content %}
<style type="text/css">
#start_backtest{
    float:right;
}
</style>

<div class="page-header">
    <h1>
    {% if current_user.is_authenticated -%}    	
	    
	    {% include "auth/collapse.html" with context %}
	    
	    {% if backtest_ready %}
		<form method="POST" action="{{ url_for('auth.backtest') }}" id = "start_backtest_form" enctype="multipart/form-data">
			{{ submit_form.hidden_tag() }}  
			<div class ="row">
				<div class="col-md-2 success" id = "start_backtest">
				<h3>
				{{ wtf.form_field(submit_form.submit1, button_map={'submit1':'success'},form_type = 'horizontal') }}
				</h3>
				</div>
			</div>
		</form>
		{% endif %}
				
		{% if start_timer%}
		<div class="row" >
			<div class="col-lg-2"><h3><p class = "text-info">&nbsp;&nbsp;&nbsp;Progress:</p></h3></div>
		</div>
		<div class="row" style="margin: 10px" >
			&nbsp;&nbsp;&nbsp;
			<div class="col-sm-12">
				<div class="progress progress-striped active" style="height:30px;">
					<div id="pbar" class="progress-bar progress-bar-success" role="progressbar"
						 aria-valuenow="0" aria-valuemin="0" aria-valuemax="100"
						 style="width: 0%;font-size: 20px;color:#000000;">
						<span id = "pbar_value">0%</span>
					</div>
				</div>
			</div>
		</div>
		{% endif %}		
						
		{% if show_result == 1 %}
			{% include "auth/backtest_result.html" with context %}
		{% elif show_error == 1 %}
			{% include "auth/backtest_error.html" with context %}
		{% endif %}
			
    {% endif %}
    </h1>
</div>

{% endblock %}

{% block scripts %}
{{ super() }}
<script>

	function queryBacktestReady(){
	    $.ajax({
		  url: $SCRIPT_ROOT + '/auth/qeury_backtest_result',
		  data: {},
		  async: false,
		  dataType: 'json',
		  success: function (result) {
		    ret = result.result;
		  }
		});
		return ret;
	};
	
	function setProgressBarValue(percent){
		$("#pbar_value").text(percent + "%");
        $('#pbar').attr('aria-valuenow', percent);
		$('#pbar').css('width', percent + '%');
	}
	
	function startTimer(duration, success_path, fail_path, min_value = 0, max_value = 6) {
	    var exp_timer = duration * 2;
	    console.log(min_value + ' ' + max_value);
	    var refresh = setInterval(function () {
		    var ret = queryBacktestReady();
		    console.log("exp_timer : " + exp_timer + " : " + ret);
		    if (ret >= min_value && ret <= max_value){
				var percent = parseint( parsedouble(ret) / max_value );
				setProgressBarValue(percent);
		    }
		    if (ret == max_value){
				clearInterval(refresh);
				console.log("backtest successed!");
				window.location.href = success_path;
		    }
	        if (--exp_timer < 0) {
	            clearInterval(refresh);
	            console.log("backtest Failed!");
	            window.location.href = fail_path;
	        }
	    }, 500);
	};
	
	$(document).ready(function(){
		{% if start_timer %}
			startTimer(30,"/auth/show_backtest_result","/auth/backtest_result_error");
		{% else %}
			console.log("backtest has not been started");
		{% endif %}
	});
</script>
{% endblock %}


