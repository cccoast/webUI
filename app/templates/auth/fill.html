{% extends "base.html" %}
{% import "bootstrap/wtf.html" as wtf %}

{% block title %}Platform{% endblock %}

{% block page_content %}
<style type="text/css">
#start_backtest{
    float:right;
}
</style>

<div class="page-header">
    <h1>
    {% if current_user.is_authenticated -%}    	
	    
	    {% include "auth/collapse.html" with context %}
	    
	    {% if backtest_ready %}
		<form method="POST" action="{{ url_for('auth.backtest') }}" id = "start_backtest_form" enctype="multipart/form-data">
			{{ submit_form.hidden_tag() }}  
			<div class ="row">
				<div class="col-md-2 success" id = "start_backtest">
				<h3>
				{{ wtf.form_field(submit_form.submit1, button_map={'submit1':'success'},form_type = 'horizontal') }}
				</h3>
				</div>
			</div>
		</form>
		{% endif %}
				
		{% if start_timer%}
		<div class="row" >
			<div class="col-lg-2"><h3><p class = "text-info">&nbsp;&nbsp;&nbsp;Progress</p></h3></div>
			<div class="col-lg-2"><h3 id = "timer_counter"></h3></div>
		</div>
		<div class="row" style="margin: 10px" >
			&nbsp;&nbsp;&nbsp;
			<div class="col-sm-12">
				<div class="progress progress-striped active" style="height:30px;">
					<div id="pbar" class="progress-bar progress-bar-success" role="progressbar"
						 aria-valuenow="0" aria-valuemin="0" aria-valuemax="100"
						 style="width: 0%;font-size: 20px;color:#000000;">
						<span id = "pbar_value">0%</span>
					</div>
				</div>
			</div>
		</div>
		{% endif %}		
						
		{% if show_result == 1 %}
			{% include "auth/backtest_result.html" with context %}
		{% elif show_error == 1 %}
			{% include "auth/backtest_error.html" with context %}
		{% endif %}
			
    {% endif %}
    </h1>
</div>

{% endblock %}

{% block scripts %}
{{ super() }}
<script>
$(document).ready(function(){	

	function queryBacktestReady(){
		var ret = -1;
	    $.ajax({
		  url: $SCRIPT_ROOT + '/auth/qeury_backtest_result',
		  data: {},
		  async: false,
		  dataType: 'json',
		  success: function (result) {
		    ret = result.result;
		  }
		});
		return ret;
	};
	
	function setProgressBarValue(percent){
		$("#pbar_value").text(percent + "%");
        $('#pbar').attr('aria-valuenow', percent);
		$('#pbar').css('width', percent + '%');
	}
	
	function setTimerCounter(seconds){
		$("#timer_counter").text(seconds + "s");
	}
	
	function startTimer(duration, success_path, fail_path, min_value = 0, max_value = 6) {
	    var exp_timer = duration * 2;
	    console.log(min_value + ' ' + max_value);
	    var refresh = setInterval(function () {
		    var ret = queryBacktestReady();
		    if(exp_timer % 2 == 0)
		    	setTimerCounter((parseInt(exp_timer))/2);
		    console.log("exp_timer : " + exp_timer + " : " + ret);
		    if (ret >= min_value && ret <= max_value){
				var percent = parseInt( parseFloat(ret) * 100 / max_value );
				console.log(percent);
				setProgressBarValue(percent);
		    }
		    if (ret == max_value){
				clearInterval(refresh);
				console.log("backtest successed!");
				window.location.href = success_path;
		    }
	        if (--exp_timer < 0) {
	            clearInterval(refresh);
	            console.log("backtest Failed!");
	            window.location.href = fail_path;
	        }
	    }, 500);
	};
	
	{% if start_timer %}
		startTimer(30,"/auth/show_backtest_result","/auth/backtest_result_error");
	{% else %}
		console.log("backtest has not been started");
	{% endif %}
	
	var entry_rule_table = $('#entry_rule_table'),
    	entry_rule_submit_button = $('#entry_rule_submit_button'),
    	entry_rule_remove_row_button = $('#entry_rule_remove_row_button'),
    	entry_rule_clear_all_button = $('#entry_rule_clearAll');
        	
	function submit_table(to_be_submitted,tar_url){
		var data = to_be_submitted.bootstrapTable('getData');
		var json_data = JSON.stringify( data );
		console.log('submit data');
		for(i=0;i<data.length;i++)
			console.log(JSON.stringify( data[i] ));
	  	$.ajax({
	  		type:"POST",
            url: tar_url,
            data: { data : json_data },
            dataType: "json",
           	async: true,
            success: function (data, status) {
                if (status == "success") {
                    console.log("Success");
                }
            },
            error: function () {
                console.log("error");
            },
            complete: function () {
            }
    	});                        	
	};	
	
	entry_rule_submit_button.click(function () {
		 console.log('click submit button');
         var tar_table = entry_rule_table;
         var url = $SCRIPT_ROOT + '/auth/update_entry_rule_data';
         submit_table(tar_table,url);
    });     
    
    entry_rule_remove_row_button.click(function () {
        var ids = $.map(entry_rule_table.bootstrapTable('getSelections'), function (json_data) {
            return json_data.id;
        });
        console.log('remove row ' + ids);
        entry_rule_table.bootstrapTable('remove', {
            field: 'id',
            values: ids
        });
        entry_rule_submit_button.click();
    }); 
    
    entry_rule_clear_all_button.click(function () {
    	console.log('remove all');
        entry_rule_table.bootstrapTable('removeAll');
        entry_rule_submit_button.click();
    });
		
});
</script>
{% endblock %}


